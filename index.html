<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Weather Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #e71d36;
            --light: #f8f9fa;
            --dark: #212529;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.18);
            --text-light: #ffffff;
            --text-dark: #333333;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s ease;
            --aqi-good: #00e400;
            --aqi-moderate: #ffff00;
            --aqi-sensitive: #ff7e00;
            --aqi-unhealthy: #ff0000;
            --aqi-very-unhealthy: #8f3f97;
            --aqi-hazardous: #7e0023;
            --favorite: #ffdd00;
        }

        .dark-theme {
            --glass-bg: rgba(0, 0, 0, 0.25);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-light: #f0f0f0;
            --text-dark: #f0f0f0;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: var(--text-light);
            background-size: cover;
            background-position: center;
            transition: var(--transition);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        /* Weather backgrounds */
        body.clear {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }
        body.clouds {
            background: linear-gradient(135deg, #bdc3c7, #2c3e50);
        }
        body.rain {
            background: linear-gradient(135deg, #373b44, #4286f4);
        }
        body.thunderstorm {
            background: linear-gradient(135deg, #0f0c29, #302b63);
        }
        body.snow {
            background: linear-gradient(135deg, #83a4d4, #b6fbff);
        }
        body.drizzle {
            background: linear-gradient(135deg, #1d2b64, #f8cdda);
        }
        body.mist {
            background: linear-gradient(135deg, #606c88, #3f4c6b);
        }
        body.default {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }

        .app-title {
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title i {
            color: #FFD700;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        .controls {
            display: flex;
            gap: 15px;
        }

        .btn {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 10px 20px;
            color: var(--text-light);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.25);
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 25px;
            border-radius: 50px;
            border: none;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-light);
            font-size: 1rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .favorites-container {
            margin-bottom: 25px;
        }

        .favorites-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .favorites-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .favorite-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }

        .favorite-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .favorite-item i {
            color: var(--favorite);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
            transition: var(--transition);
            min-height: 300px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-weather {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .weather-icon {
            font-size: 6rem;
            margin: 15px 0;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
        }

        .temperature {
            font-size: 4rem;
            font-weight: 700;
            margin: 10px 0;
            display: flex;
            align-items: flex-start;
        }

        .temperature span {
            font-size: 2rem;
            margin-top: 10px;
        }

        .weather-description {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-transform: capitalize;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
            transition: transform 0.3s ease;
        }

        .detail-item:hover {
            transform: scale(1.05);
        }

        .detail-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 10px 0 5px;
        }

        .detail-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .forecast-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .forecast-day {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
            transition: var(--transition);
        }

        .forecast-day:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .forecast-date {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .forecast-icon {
            font-size: 2.5rem;
            margin: 10px 0;
        }

        .forecast-temp {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .spinner {
            width: 70px;
            height: 70px;
            border: 7px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            text-align: center;
            padding: 30px;
            background: rgba(231, 29, 54, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(231, 29, 54, 0.3);
        }

        .location-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            font-size: 1.1rem;
            justify-content: center;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Toggle Switch */
        .toggle-container {
            display: inline-block;
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-container input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Unit switch */
        .unit-switch {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 5px;
        }

        .unit-btn {
            padding: 8px 15px;
            border-radius: 50px;
            background: transparent;
            border: none;
            color: var(--text-light);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .unit-btn.active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Country flag styles */
        .country-flag {
            height: 24px;
            width: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-left: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* AQI styles */
        .aqi-value {
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 5px;
            display: inline-block;
        }
        
        .aqi-good { background-color: var(--aqi-good); color: #000; }
        .aqi-moderate { background-color: var(--aqi-moderate); color: #000; }
        .aqi-sensitive { background-color: var(--aqi-sensitive); color: #000; }
        .aqi-unhealthy { background-color: var(--aqi-unhealthy); color: #fff; }
        .aqi-very-unhealthy { background-color: var(--aqi-very-unhealthy); color: #fff; }
        .aqi-hazardous { background-color: var(--aqi-hazardous); color: #fff; }

        /* Favorite button */
        .favorite-btn {
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            margin-left: 10px;
        }

        .favorite-btn.favorited {
            color: var(--favorite);
            text-shadow: 0 0 8px rgba(255, 221, 0, 0.5);
        }

        .favorite-btn:hover {
            transform: scale(1.2);
        }

        /* Responsive adjustments */
        @media (max-width: 576px) {
            .app-title {
                font-size: 1.8rem;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .temperature {
                font-size: 3rem;
            }
            
            .weather-icon {
                font-size: 5rem;
            }
            
            .controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .detail-item {
                min-width: 100px;
                padding: 10px;
            }
            
            .detail-value {
                font-size: 1.3rem;
            }
            
            .country-flag {
                height: 20px;
                margin-left: 5px;
            }
            
            .weather-details {
                grid-template-columns: 1fr;
            }
        }
        
        /* Header decoration */
        .header-decoration {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #ff9d00, #ff0080, #4361ee, #3a0ca3);
            z-index: 10;
        }
        
        .sun-times {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            width: 100%;
        }
        
        .sun-time {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .sun-icon {
            font-size: 2rem;
            color: #ff9800;
        }
    </style>
</head>
<body class="default">
    <div class="header-decoration"></div>
    <div class="container">
        <header>
            <h1 class="app-title"><i class="fas fa-cloud-sun"></i> Weather Dashboard</h1>
            <div class="controls">
                <div class="unit-switch">
                    <button id="celsius-btn" class="unit-btn active">°C</button>
                    <button id="fahrenheit-btn" class="unit-btn">°F</button>
                </div>
                <div class="toggle-container">
                    <input type="checkbox" id="theme-toggle">
                    <label class="toggle-slider" for="theme-toggle"></label>
                </div>
                <button class="btn" id="location-btn">
                    <i class="fas fa-location-arrow"></i> My Location
                </button>
            </div>
        </header>
        
        <div class="search-container">
            <input 
                type="text" 
                class="search-input" 
                id="city-input" 
                placeholder="Enter city name..."
                value="London"
            >
            <button class="btn" id="search-btn">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
        
        <div class="favorites-container">
            <h3 class="favorites-title"><i class="fas fa-star"></i> Favorite Locations</h3>
            <div class="favorites-list" id="favorites-list">
                <!-- Favorites will be added here dynamically -->
            </div>
        </div>
        
        <div class="main-content">
            <div class="card current-weather">
                <div class="loading" id="current-loading">
                    <div class="spinner"></div>
                    <p>Loading current weather data...</p>
                </div>
                <div id="current-weather-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <h2 class="card-title">
                            <i class="fas fa-location-dot"></i> 
                            <span id="city-name">London</span>
                            <img id="country-flag" class="country-flag" src="" alt="Country Flag">
                        </h2>
                        <button class="favorite-btn" id="favorite-btn" title="Add to favorites">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="location-info">
                        <span id="current-date">Monday, June 16, 2025</span>
                    </div>
                    <div class="weather-icon">
                        <i id="weather-icon" class="fas fa-sun"></i>
                    </div>
                    <div class="temperature">
                        <span id="current-temp">22</span><span>°</span>
                    </div>
                    <div class="weather-description" id="weather-desc">Sunny</div>
                    
                    <div class="sun-times">
                        <div class="sun-time">
                            <i class="fas fa-sunrise sun-icon"></i>
                            <div>Sunrise</div>
                            <div class="detail-value" id="sunrise-time">06:15</div>
                        </div>
                        <div class="sun-time">
                            <i class="fas fa-sunset sun-icon"></i>
                            <div>Sunset</div>
                            <div class="detail-value" id="sunset-time">20:45</div>
                        </div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="detail-item">
                            <i class="fas fa-wind"></i>
                            <div class="detail-value" id="wind-speed">5.2</div>
                            <div class="detail-label">Wind (m/s)</div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-tint"></i>
                            <div class="detail-value" id="humidity">65</div>
                            <div class="detail-label">Humidity (%)</div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-eye"></i>
                            <div class="detail-value" id="visibility">10</div>
                            <div class="detail-label">Visibility (km)</div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-lungs"></i>
                            <div class="detail-value" id="aqi-value">-</div>
                            <div class="detail-label">Air Quality</div>
                        </div>
                    </div>
                </div>
                <div id="current-error" class="error-message" style="display: none;">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                    <h3>Error Loading Data</h3>
                    <p>Unable to fetch current weather data. Please try again.</p>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i class="fas fa-calendar-days"></i> 5-Day Forecast</h2>
                <div class="loading" id="forecast-loading">
                    <div class="spinner"></div>
                    <p>Loading forecast data...</p>
                </div>
                <div class="forecast-container" id="forecast-content" style="display: none;"></div>
                <div id="forecast-error" class="error-message" style="display: none;">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                    <h3>Error Loading Forecast</h3>
                    <p>Unable to fetch forecast data. Please try again.</p>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Weather Dashboard &copy; 2025 | Real-time weather data powered by OpenWeatherMap API</p>
        </footer>
    </div>

    <script>
        // Initialize all DOM elements after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const cityInput = document.getElementById('city-input');
            const searchBtn = document.getElementById('search-btn');
            const locationBtn = document.getElementById('location-btn');
            const celsiusBtn = document.getElementById('celsius-btn');
            const fahrenheitBtn = document.getElementById('fahrenheit-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const countryFlag = document.getElementById('country-flag');
            const aqiValue = document.getElementById('aqi-value');
            const favoriteBtn = document.getElementById('favorite-btn');
            const favoritesList = document.getElementById('favorites-list');
            const sunriseTime = document.getElementById('sunrise-time');
            const sunsetTime = document.getElementById('sunset-time');
            
            // Weather display elements
            const cityName = document.getElementById('city-name');
            const currentDate = document.getElementById('current-date');
            const weatherIcon = document.getElementById('weather-icon');
            const currentTemp = document.getElementById('current-temp');
            const weatherDesc = document.getElementById('weather-desc');
            const windSpeed = document.getElementById('wind-speed');
            const humidity = document.getElementById('humidity');
            const visibility = document.getElementById('visibility');
            const uvIndex = document.getElementById('uv-index');
            const forecastContent = document.getElementById('forecast-content');
            
            // Loading elements
            const currentLoading = document.getElementById('current-loading');
            const currentWeatherContent = document.getElementById('current-weather-content');
            const currentError = document.getElementById('current-error');
            const forecastLoading = document.getElementById('forecast-loading');
            const forecastError = document.getElementById('forecast-error');
            
            // API Key and base URL (using OpenWeatherMap API)
            const API_KEY = '6c9b9fde58e114c66bb3e0c932228933';
            const BASE_URL = 'https://api.openweathermap.org/data/2.5';
            
            // State
            let currentUnit = 'celsius';
            let currentWeatherData = null;
            let forecastData = null;
            let favorites = JSON.parse(localStorage.getItem('weatherFavorites')) || [];
            
            // Initialize the app
            function initApp() {
                // Set current date
                updateCurrentDate();
                
                // Render favorites
                renderFavorites();
                
                // Load default city weather
                getWeatherData('London');
                
                // Event listeners
                searchBtn.addEventListener('click', () => {
                    const city = cityInput.value.trim();
                    if (city) {
                        getWeatherData(city);
                    }
                });
                
                cityInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const city = cityInput.value.trim();
                        if (city) {
                            getWeatherData(city);
                        }
                    }
                });
                
                locationBtn.addEventListener('click', getLocationWeather);
                
                celsiusBtn.addEventListener('click', () => {
                    setUnit('celsius');
                });
                
                fahrenheitBtn.addEventListener('click', () => {
                    setUnit('fahrenheit');
                });
                
                themeToggle.addEventListener('change', toggleTheme);
                
                favoriteBtn.addEventListener('click', toggleFavorite);
            }
            
            // Update current date display
            function updateCurrentDate() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                currentDate.textContent = now.toLocaleDateString('en-US', options);
            }
            
            // Get weather data for a city
            async function getWeatherData(city) {
                // Show loading states
                showLoading();
                
                try {
                    // Get current weather
                    const currentResponse = await fetch(`${BASE_URL}/weather?q=${city}&appid=${API_KEY}&units=metric`);
                    const currentData = await currentResponse.json();
                    
                    if (currentData.cod !== 200) {
                        throw new Error(currentData.message);
                    }
                    
                    currentWeatherData = currentData;
                    
                    // Get forecast
                    const forecastResponse = await fetch(`${BASE_URL}/forecast?q=${city}&appid=${API_KEY}&units=metric`);
                    const forecastDataResponse = await forecastResponse.json();
                    
                    if (forecastDataResponse.cod !== '200') {
                        throw new Error(forecastDataResponse.message);
                    }
                    
                    forecastData = forecastDataResponse;
                    
                    // Get air quality data
                    const aqiData = await getAQIData(currentData.coord.lat, currentData.coord.lon);
                    
                    // Update UI
                    updateWeatherUI();
                    updateForecastUI();
                    updateBodyBackground(currentData.weather[0].main.toLowerCase());
                    
                    // Update AQI display
                    updateAQIDisplay(aqiData);
                    
                    // Update country flag
                    updateCountryFlag(currentData.sys.country);
                    
                    // Update favorite button
                    updateFavoriteButton(city);
                    
                    // Hide loading and show content
                    hideLoading();
                } catch (error) {
                    console.error('Error fetching weather data:', error);
                    showError(error.message);
                }
            }
            
            // Get air quality data
            async function getAQIData(lat, lon) {
                try {
                    // Simulated AQI data
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return Math.floor(Math.random() * 5) + 1;
                } catch (error) {
                    console.error('Error fetching AQI data:', error);
                    return null;
                }
            }
            
            // Update AQI display
            function updateAQIDisplay(aqi) {
                if (aqiValue && aqi !== null) {
                    aqiValue.textContent = aqi;
                    
                    // Set AQI class based on value
                    aqiValue.className = 'aqi-value ';
                    if (aqi <= 1) {
                        aqiValue.classList.add('aqi-good');
                    } else if (aqi <= 2) {
                        aqiValue.classList.add('aqi-moderate');
                    } else if (aqi <= 3) {
                        aqiValue.classList.add('aqi-sensitive');
                    } else if (aqi <= 4) {
                        aqiValue.classList.add('aqi-unhealthy');
                    } else if (aqi <= 5) {
                        aqiValue.classList.add('aqi-very-unhealthy');
                    } else {
                        aqiValue.classList.add('aqi-hazardous');
                    }
                }
            }
            
            // Update country flag
            function updateCountryFlag(countryCode) {
                if (countryFlag && countryCode) {
                    countryFlag.style.display = 'inline-block';
                    countryFlag.src = `https://flagcdn.com/24x18/${countryCode.toLowerCase()}.png`;
                    countryFlag.alt = `${countryCode} flag`;
                    countryFlag.title = countryCode;
                }
            }
            
            // Update favorite button
            function updateFavoriteButton(city) {
                if (favoriteBtn) {
                    const isFavorite = favorites.includes(city);
                    favoriteBtn.innerHTML = isFavorite 
                        ? '<i class="fas fa-star"></i>' 
                        : '<i class="far fa-star"></i>';
                    favoriteBtn.classList.toggle('favorited', isFavorite);
                }
            }
            
            // Toggle favorite status
            function toggleFavorite() {
                const city = cityInput.value.trim();
                if (!city) return;
                
                const index = favorites.indexOf(city);
                
                if (index === -1) {
                    // Add to favorites
                    favorites.push(city);
                    favoriteBtn.innerHTML = '<i class="fas fa-star"></i>';
                    favoriteBtn.classList.add('favorited');
                } else {
                    // Remove from favorites
                    favorites.splice(index, 1);
                    favoriteBtn.innerHTML = '<i class="far fa-star"></i>';
                    favoriteBtn.classList.remove('favorited');
                }
                
                // Save to localStorage
                localStorage.setItem('weatherFavorites', JSON.stringify(favorites));
                
                // Render favorites
                renderFavorites();
            }
            
            // Render favorites list
            function renderFavorites() {
                if (favoritesList) {
                    favoritesList.innerHTML = '';
                    
                    if (favorites.length === 0) {
                        favoritesList.innerHTML = '<div style="opacity:0.7;">No favorites yet. Add some cities!</div>';
                        return;
                    }
                    
                    favorites.forEach(city => {
                        const favoriteItem = document.createElement('div');
                        favoriteItem.className = 'favorite-item';
                        favoriteItem.innerHTML = `
                            <i class="fas fa-star"></i>
                            <span>${city}</span>
                        `;
                        
                        favoriteItem.addEventListener('click', () => {
                            cityInput.value = city;
                            getWeatherData(city);
                        });
                        
                        favoritesList.appendChild(favoriteItem);
                    });
                }
            }
            
            // Format time from timestamp
            function formatTime(timestamp, timezone) {
                const date = new Date((timestamp + timezone) * 1000);
                const hours = date.getUTCHours().toString().padStart(2, '0');
                const minutes = date.getUTCMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            
            // Get weather based on user location
            function getLocationWeather() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            
                            // Show loading states
                            showLoading();
                            
                            try {
                                // Get current weather by coordinates
                                const currentResponse = await fetch(`${BASE_URL}/weather?lat=${latitude}&lon=${longitude}&appid=${API_KEY}&units=metric`);
                                const currentData = await currentResponse.json();
                                
                                if (currentData.cod !== 200) {
                                    throw new Error(currentData.message);
                                }
                                
                                currentWeatherData = currentData;
                                
                                // Get forecast by coordinates
                                const forecastResponse = await fetch(`${BASE_URL}/forecast?lat=${latitude}&lon=${longitude}&appid=${API_KEY}&units=metric`);
                                const forecastDataResponse = await forecastResponse.json();
                                
                                if (forecastDataResponse.cod !== '200') {
                                    throw new Error(forecastDataResponse.message);
                                }
                                
                                forecastData = forecastDataResponse;
                                
                                // Get air quality data
                                const aqiData = await getAQIData(latitude, longitude);
                                
                                // Update UI
                                updateWeatherUI();
                                updateForecastUI();
                                updateBodyBackground(currentData.weather[0].main.toLowerCase());
                                
                                // Update AQI display
                                updateAQIDisplay(aqiData);
                                
                                // Update country flag
                                updateCountryFlag(currentData.sys.country);
                                
                                // Update city input
                                cityInput.value = currentData.name;
                                
                                // Update favorite button
                                updateFavoriteButton(currentData.name);
                                
                                // Hide loading and show content
                                hideLoading();
                            } catch (error) {
                                console.error('Error fetching location weather:', error);
                                showError(error.message);
                            }
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            showError('Location access denied. Please enable location services or search for a city.');
                        }
                    );
                } else {
                    showError('Geolocation is not supported by your browser.');
                }
            }
            
            // Update weather UI
            function updateWeatherUI() {
                if (currentWeatherData) {
                    if (cityName) cityName.textContent = `${currentWeatherData.name}, ${currentWeatherData.sys.country}`;
                    
                    // Set weather icon
                    const weatherMain = currentWeatherData.weather[0].main.toLowerCase();
                    if (weatherIcon) setWeatherIcon(weatherIcon, weatherMain);
                    
                    // Set temperature based on current unit
                    if (currentTemp) {
                        if (currentUnit === 'celsius') {
                            currentTemp.textContent = Math.round(currentWeatherData.main.temp);
                        } else {
                            const tempF = (currentWeatherData.main.temp * 9/5) + 32;
                            currentTemp.textContent = Math.round(tempF);
                        }
                    }
                    
                    if (weatherDesc) weatherDesc.textContent = currentWeatherData.weather[0].description;
                    if (windSpeed) windSpeed.textContent = currentWeatherData.wind.speed.toFixed(1);
                    if (humidity) humidity.textContent = currentWeatherData.main.humidity;
                    
                    // Convert visibility from meters to km
                    if (visibility) visibility.textContent = (currentWeatherData.visibility / 1000).toFixed(1);
                    
                    // Update sunrise and sunset times
                    if (sunriseTime && sunsetTime) {
                        sunriseTime.textContent = formatTime(currentWeatherData.sys.sunrise, currentWeatherData.timezone);
                        sunsetTime.textContent = formatTime(currentWeatherData.sys.sunset, currentWeatherData.timezone);
                    }
                    
                    // Generate a UV index for demonstration
                    if (uvIndex) uvIndex.textContent = Math.floor(Math.random() * 10) + 1;
                }
            }
            
            // Update forecast UI
            function updateForecastUI() {
                if (forecastData && forecastContent) {
                    // Filter to get one forecast per day (at 12:00 PM)
                    const dailyForecast = forecastData.list.filter(item => {
                        return item.dt_txt.includes('12:00:00');
                    }).slice(0, 5);
                    
                    forecastContent.innerHTML = '';
                    
                    dailyForecast.forEach(day => {
                        const date = new Date(day.dt * 1000);
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                        
                        // Set temperature based on current unit
                        let temp;
                        if (currentUnit === 'celsius') {
                            temp = Math.round(day.main.temp);
                        } else {
                            temp = Math.round((day.main.temp * 9/5) + 32);
                        }
                        
                        const forecastDay = document.createElement('div');
                        forecastDay.className = 'forecast-day';
                        forecastDay.innerHTML = `
                            <div class="forecast-date">${dayName}</div>
                            <div class="forecast-icon">${getWeatherIcon(day.weather[0].main.toLowerCase())}</div>
                            <div class="forecast-temp">${temp}<span>°</span></div>
                            <div class="weather-description">${day.weather[0].description}</div>
                        `;
                        
                        forecastContent.appendChild(forecastDay);
                    });
                }
            }
            
            // Set weather icon based on condition
            function setWeatherIcon(element, condition) {
                let iconClass;
                
                switch(condition) {
                    case 'clear':
                        iconClass = 'fas fa-sun';
                        break;
                    case 'clouds':
                        iconClass = 'fas fa-cloud';
                        break;
                    case 'rain':
                        iconClass = 'fas fa-cloud-rain';
                        break;
                    case 'thunderstorm':
                        iconClass = 'fas fa-bolt';
                        break;
                    case 'snow':
                        iconClass = 'fas fa-snowflake';
                        break;
                    case 'drizzle':
                        iconClass = 'fas fa-cloud-sun-rain';
                        break;
                    case 'mist':
                    case 'smoke':
                    case 'haze':
                    case 'fog':
                        iconClass = 'fas fa-smog';
                        break;
                    default:
                        iconClass = 'fas fa-cloud';
                }
                
                element.className = iconClass;
            }
            
            // Get weather icon for forecast
            function getWeatherIcon(condition) {
                let iconClass;
                
                switch(condition) {
                    case 'clear':
                        iconClass = 'fas fa-sun';
                        break;
                    case 'clouds':
                        iconClass = 'fas fa-cloud';
                        break;
                    case 'rain':
                        iconClass = 'fas fa-cloud-rain';
                        break;
                    case 'thunderstorm':
                        iconClass = 'fas fa-bolt';
                        break;
                    case 'snow':
                        iconClass = 'fas fa-snowflake';
                        break;
                    case 'drizzle':
                        iconClass = 'fas fa-cloud-sun-rain';
                        break;
                    case 'mist':
                    case 'smoke':
                    case 'haze':
                    case 'fog':
                        iconClass = 'fas fa-smog';
                        break;
                    default:
                        iconClass = 'fas fa-cloud';
                }
                
                return `<i class="${iconClass}"></i>`;
            }
            
            // Update body background based on weather condition
            function updateBodyBackground(condition) {
                document.body.className = condition;
            }
            
            // Set temperature unit
            function setUnit(unit) {
                currentUnit = unit;
                
                // Update UI for active button
                if (celsiusBtn && fahrenheitBtn) {
                    if (unit === 'celsius') {
                        celsiusBtn.classList.add('active');
                        fahrenheitBtn.classList.remove('active');
                    } else {
                        fahrenheitBtn.classList.remove('active');
                        celsiusBtn.classList.remove('active');
                        fahrenheitBtn.classList.add('active');
                    }
                }
                
                // Update temperatures
                if (currentWeatherData) updateWeatherUI();
                if (forecastData) updateForecastUI();
            }
            
            // Toggle theme (light/dark)
            function toggleTheme() {
                document.body.classList.toggle('dark-theme');
            }
            
            // Show loading states
            function showLoading() {
                if (currentLoading) currentLoading.style.display = 'flex';
                if (currentWeatherContent) currentWeatherContent.style.display = 'none';
                if (currentError) currentError.style.display = 'none';
                
                if (forecastLoading) forecastLoading.style.display = 'flex';
                if (forecastContent) forecastContent.style.display = 'none';
                if (forecastError) forecastError.style.display = 'none';
            }
            
            // Hide loading and show content
            function hideLoading() {
                if (currentLoading) currentLoading.style.display = 'none';
                if (currentWeatherContent) currentWeatherContent.style.display = 'block';
                
                if (forecastLoading) forecastLoading.style.display = 'none';
                if (forecastContent) forecastContent.style.display = 'grid';
            }
            
            // Show error message
            function showError(message) {
                if (currentLoading) currentLoading.style.display = 'none';
                if (currentWeatherContent) currentWeatherContent.style.display = 'none';
                if (currentError) {
                    currentError.style.display = 'block';
                    const errorText = currentError.querySelector('p');
                    if (errorText) errorText.textContent = message;
                }
                
                if (forecastLoading) forecastLoading.style.display = 'none';
                if (forecastContent) forecastContent.style.display = 'none';
                if (forecastError) {
                    forecastError.style.display = 'block';
                    const errorText = forecastError.querySelector('p');
                    if (errorText) errorText.textContent = message;
                }
            }
            
            // Initialize the app
            initApp();
        });
    </script>
</body>
</html>